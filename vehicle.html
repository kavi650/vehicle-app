<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WheelDeal - Live Map Marketplace</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #0f172a;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --text-main: #374151;
            --text-light: #6b7280;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f9fafb; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-verified { color: var(--primary); margin-left: 4px; }

        /* --- MAP STYLES --- */
        #map-wrapper { height: 100%; width: 100%; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); position: relative; z-index: 1; }
        #map-container { height: 100%; width: 100%; }
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; }
        .leaflet-popup-content { margin: 10px; width: 200px !important; }
        .map-card h4 { margin: 0 0 5px 0; color: var(--secondary); font-size: 1rem; }
        .map-card p { margin: 0 0 8px 0; font-size: 0.85rem; color: var(--text-light); }
        .map-price { font-weight: bold; color: var(--primary); font-size: 1.1rem; }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--secondary), var(--primary)); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 2.5rem; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; outline: none; }

        /* --- LAYOUT --- */
        nav { background: white; border-bottom: 1px solid var(--border); padding: 0 2rem; height: 64px; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .nav-links button { background: none; border: none; padding: 0.5rem 1rem; color: var(--text-light); font-weight: 500; cursor: pointer; }
        .nav-links button.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: white; border-right: 1px solid var(--border); padding: 1.5rem; overflow-y: auto; display: none; }
        .view-buy .sidebar { display: block; }
        .content-area { flex: 1; padding: 2rem; overflow-y: auto; position: relative; }
        .section { height: 100%; display: flex; flex-direction: column; }

        /* --- GRID CARDS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; padding-bottom: 2rem; }
        .card { background: white; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card-img { height: 160px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #9ca3af; }
        .card-body { padding: 1rem; }
        .card-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; }
        .card-price { font-size: 1.25rem; font-weight: 700; color: var(--secondary); margin-bottom: 0.5rem; }

        /* --- ADMIN & CHAT --- */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 2rem; font-weight: 700; color: var(--primary); }
        
        .chat-layout { display: flex; height: 100%; border: 1px solid var(--border); border-radius: 8px; background: white; overflow: hidden; }
        .chat-list { width: 250px; border-right: 1px solid var(--border); background: #f9fafb; }
        .chat-window { flex: 1; display: flex; flex-direction: column; }
        .messages { flex: 1; padding: 1rem; overflow-y: auto; background: white; }
        .msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; max-width: 70%; font-size: 0.9rem; }
        .msg-sent { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; }
        .msg-received { background: #e5e7eb; align-self: flex-start; }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal.open { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-card">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h1 style="color: var(--primary);"><i class="fas fa-steering-wheel"></i> WheelDeal</h1>
                <p style="color: var(--text-light);">Map-Enabled Marketplace</p>
            </div>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="login-user" placeholder="user or admin">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="login-pass" placeholder="123 or admin">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="attemptLogin()">Login</button>
            <div style="margin-top: 1rem; font-size: 0.8rem; background: #f3f4f6; padding: 10px; border-radius: 6px;">
                User: <code>user / 123</code> | Admin: <code>admin / admin</code>
            </div>
        </div>
    </div>

    <nav id="navbar" class="hidden">
        <div class="logo"><i class="fas fa-car-side"></i> WheelDeal</div>
        <div class="nav-links" id="nav-items"></div>
        <div class="flex items-center gap-2">
            <span id="user-display" style="font-weight: 600; font-size: 0.9rem;"></span>
            <button class="btn btn-outline" style="padding: 0.4rem 0.8rem;" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <div id="main-app" class="main-container hidden">
        
        <div class="sidebar" id="sidebar">
            <h3 style="margin-bottom: 1rem;">Filters</h3>
            <div class="input-group">
                <label>Category</label>
                <select id="filter-cat" onchange="renderApp()" style="padding: 8px;">
                    <option value="all">All</option>
                    <option value="Car">Cars</option>
                    <option value="Bike">Bikes</option>
                </select>
            </div>
            <div class="input-group">
                <label>Max Price: ₹<span id="price-val">10L</span></label>
                <input type="range" id="filter-price" min="0" max="1000000" step="50000" value="1000000" oninput="renderApp()">
            </div>
            <div class="input-group">
                <label><input type="checkbox" id="filter-verified" onchange="renderApp()"> Verified Sellers Only</label>
            </div>
        </div>

        <div class="content-area">
            
            <div id="view-buy" class="section hidden">
                <div class="flex justify-between items-center" style="margin-bottom: 1rem;">
                    <input type="text" id="search-bar" placeholder="Search..." onkeyup="renderApp()" style="padding: 0.6rem; width: 250px; border: 1px solid var(--border); border-radius: 6px;">
                    
                    <div class="flex gap-2" style="background: white; padding: 4px; border-radius: 6px; border: 1px solid var(--border);">
                        <button class="btn" id="btn-list" onclick="toggleViewMode('list')" style="background: var(--bg); font-size:0.8rem;"><i class="fas fa-list"></i> List</button>
                        <button class="btn" id="btn-map" onclick="toggleViewMode('map')" style="background: white; font-size:0.8rem;"><i class="fas fa-map-marker-alt"></i> Map</button>
                    </div>
                </div>

                <div class="grid" id="listings-grid"></div>

                <div id="map-wrapper" class="hidden">
                    <div id="map-container"></div>
                </div>
            </div>

            <div id="view-sell" class="section hidden">
                <div style="max-width: 600px; margin: 0 auto; width: 100%;">
                    <h2>Sell Your Vehicle</h2>
                    <div class="login-card" style="max-width: 100%; margin-top: 1rem;">
                        <form onsubmit="handleSell(event)">
                            <div class="input-group"><label>Title</label><input type="text" id="sell-title" required></div>
                            <div class="flex gap-4">
                                <div class="input-group" style="flex:1"><label>Price</label><input type="number" id="sell-price" required></div>
                                <div class="input-group" style="flex:1"><label>Category</label>
                                    <select id="sell-cat"><option>Car</option><option>Bike</option></select>
                                </div>
                            </div>
                            <div class="input-group"><label>City</label><input type="text" id="sell-loc" required></div>
                            <button type="submit" class="btn btn-primary" style="width:100%">Post Ad</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="view-chat" class="section hidden">
                <h2>Messages</h2>
                <div class="chat-layout" style="margin-top: 1rem;">
                    <div class="chat-list" style="padding: 1rem;">
                        <div style="padding: 10px; background: white; border-radius: 6px; border: 1px solid var(--border); font-weight: bold;">Support Team</div>
                    </div>
                    <div class="chat-window">
                        <div class="messages" id="chat-msgs">
                            <div class="msg msg-received">Hello! How can we help you?</div>
                        </div>
                        <div style="padding: 1rem; border-top: 1px solid var(--border); display: flex; gap: 10px;">
                            <input type="text" id="chat-input" placeholder="Type here..." style="flex: 1;">
                            <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-admin" class="section hidden">
                <h2>Admin Dashboard</h2>
                <div class="stats-grid" style="margin-top: 1rem;">
                    <div class="stat-card">
                        <div style="font-size: 0.9rem; color: #666;">Total Ads</div>
                        <div class="stat-val" id="adm-total">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 0.9rem; color: #666;">Pending</div>
                        <div class="stat-val" id="adm-pending" style="color: var(--accent)">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 0.9rem; color: #666;">Revenue</div>
                        <div class="stat-val" id="adm-rev" style="color: var(--success)">₹0</div>
                    </div>
                </div>
                <h3>Pending Approvals</h3>
                <div class="grid" id="admin-grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));"></div>
            </div>

        </div>
    </div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <h2>Confirm Booking</h2>
            <div id="booking-details" style="background: var(--bg); padding: 1rem; margin: 1rem 0; border-radius: 8px;"></div>
            <div class="flex gap-2">
                <button class="btn btn-outline" style="flex:1" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" style="flex:1" onclick="confirmPayment()">Pay ₹1,500</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- STATE & DATA ---
        let state = {
            currentUser: null,
            viewMode: 'list', // 'list' or 'map'
            revenue: 4500,
            listings: [
                { id: 101, title: "Royal Enfield Classic 350", price: 150000, cat: "Bike", loc: "New Delhi", lat: 28.6139, lng: 77.2090, status: "sale", seller: "Raj Motors", verified: true, approved: true },
                { id: 102, title: "Hyundai i20 Asta 2019", price: 650000, cat: "Car", loc: "Mumbai", lat: 19.0760, lng: 72.8777, status: "sale", seller: "Sarah J.", verified: false, approved: true },
                { id: 103, title: "Honda Activa 6G", price: 72000, cat: "Bike", loc: "Pune", lat: 18.5204, lng: 73.8567, status: "booked", seller: "Amit Kumar", verified: true, approved: true },
                { id: 104, title: "Maruti Swift Dzire", price: 420000, cat: "Car", loc: "Chennai", lat: 13.0827, lng: 80.2707, status: "sale", seller: "DriveEasy", verified: true, approved: true },
                { id: 105, title: "KTM Duke 200", price: 180000, cat: "Bike", loc: "Bangalore", lat: 12.9716, lng: 77.5946, status: "sale", seller: "Vikram", verified: false, approved: false }
            ]
        };

        let map = null;
        let markers = [];
        let bookingId = null;

        // --- AUTHENTICATION ---
        function attemptLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;

            if (u === 'admin' && p === 'admin') {
                state.currentUser = 'admin';
                initApp();
            } else if (u === 'user' && p === '123') {
                state.currentUser = 'user';
                initApp();
            } else {
                alert("Invalid credentials!");
            }
        }

        function initApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-display').innerText = state.currentUser === 'admin' ? 'Admin Panel' : 'John Doe';
            
            // Setup Nav
            const nav = document.getElementById('nav-items');
            nav.innerHTML = '';
            const links = state.currentUser === 'admin' 
                ? [{id:'view-admin', label:'Dashboard'}] 
                : [{id:'view-buy', label:'Buy'}, {id:'view-sell', label:'Sell'}, {id:'view-chat', label:'Chat'}];
            
            links.forEach(l => {
                nav.innerHTML += `<button onclick="switchView('${l.id}')" id="btn-${l.id}">${l.label}</button>`;
            });

            // Initial View
            switchView(links[0].id);
        }

        function switchView(viewId) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-links button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(viewId).classList.remove('hidden');
            const btn = document.getElementById(`btn-${viewId}`);
            if(btn) btn.classList.add('active');

            // Handle sidebar visibility
            const sidebar = document.getElementById('sidebar');
            const app = document.getElementById('main-app');
            
            if(viewId === 'view-buy') {
                app.classList.add('view-buy');
                renderApp();
                // Map fix logic if switching back to buy view while map mode is active
                if(state.viewMode === 'map') setTimeout(() => { if(map) map.invalidateSize(); }, 100);
            } else if (viewId === 'view-admin') {
                app.classList.remove('view-buy');
                renderAdmin();
            } else {
                app.classList.remove('view-buy');
            }
        }

        // --- BUY & MAP LOGIC ---
        function toggleViewMode(mode) {
            state.viewMode = mode;
            const listDiv = document.getElementById('listings-grid');
            const mapDiv = document.getElementById('map-wrapper');
            const btnList = document.getElementById('btn-list');
            const btnMap = document.getElementById('btn-map');

            if (mode === 'map') {
                listDiv.classList.add('hidden');
                mapDiv.classList.remove('hidden');
                btnMap.style.background = '#e5e7eb'; // Active gray
                btnList.style.background = 'white';
                initMap();
            } else {
                mapDiv.classList.add('hidden');
                listDiv.classList.remove('hidden');
                btnList.style.background = '#e5e7eb';
                btnMap.style.background = 'white';
            }
            renderApp();
        }

        function renderApp() {
            // Get Filter Values
            const search = document.getElementById('search-bar').value.toLowerCase();
            const cat = document.getElementById('filter-cat').value;
            const maxPrice = document.getElementById('filter-price').value;
            const verifiedOnly = document.getElementById('filter-verified').checked;

            document.getElementById('price-val').innerText = (maxPrice/100000).toFixed(1) + "L";

            // Filter Data
            const filtered = state.listings.filter(item => {
                if(!item.approved) return false;
                if(search && !item.title.toLowerCase().includes(search)) return false;
                if(cat !== 'all' && item.cat !== cat) return false;
                if(item.price > maxPrice) return false;
                if(verifiedOnly && !item.verified) return false;
                return true;
            });

            // Render List
            const grid = document.getElementById('listings-grid');
            grid.innerHTML = '';
            
            filtered.forEach(item => {
                const badge = item.verified ? `<i class="fas fa-check-circle badge-verified"></i>` : '';
                let btn = item.status === 'sale' 
                    ? `<button class="btn btn-primary" style="width:100%" onclick="openBooking(${item.id})">Book Now</button>`
                    : `<button class="btn" disabled style="width:100%; background:#ccc;">${item.status}</button>`;

                grid.innerHTML += `
                    <div class="card">
                        <div class="card-img"><i class="fas fa-${item.cat === 'Bike' ? 'motorcycle' : 'car'}"></i></div>
                        <div class="card-body">
                            <div class="card-title">${item.title}</div>
                            <div class="card-price">₹${item.price.toLocaleString()}</div>
                            <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                                <i class="fas fa-map-marker-alt"></i> ${item.loc} | ${item.seller} ${badge}
                            </div>
                            ${btn}
                        </div>
                    </div>
                `;
            });

            // Update Map Markers
            if(state.viewMode === 'map' && map) {
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                filtered.forEach(item => {
                    const marker = L.marker([item.lat, item.lng]).addTo(map);
                    const popupHtml = `
                        <div class="map-card">
                            <h4>${item.title}</h4>
                            <p class="map-price">₹${item.price.toLocaleString()}</p>
                            <p>${item.loc}</p>
                            ${item.status === 'sale' ? `<button class="btn btn-primary" style="font-size:0.75rem; padding:5px 10px; width:100%" onclick="openBooking(${item.id})">Book</button>` : `<span style="color:red; font-size:0.8rem">Sold/Booked</span>`}
                        </div>
                    `;
                    marker.bindPopup(popupHtml);
                    markers.push(marker);
                });
            }
        }

        function initMap() {
            if (map) {
                setTimeout(() => map.invalidateSize(), 100);
                return;
            }
            map = L.map('map-container').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
        }

        // --- BOOKING ---
        function openBooking(id) {
            bookingId = id;
            const item = state.listings.find(i => i.id === id);
            document.getElementById('booking-details').innerHTML = `
                <h3>${item.title}</h3>
                <p>Price: ₹${item.price.toLocaleString()}</p>
                <p>Location: ${item.loc}</p>
            `;
            document.getElementById('booking-modal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('booking-modal').classList.remove('open');
            bookingId = null;
        }

        function confirmPayment() {
            if(bookingId) {
                const item = state.listings.find(i => i.id === bookingId);
                item.status = 'booked';
                state.revenue += 1500;
                alert("Booking Successful!");
                closeModal();
                renderApp();
            }
        }

        // --- SELL ---
        function handleSell(e) {
            e.preventDefault();
            const newItem = {
                id: Date.now(),
                title: document.getElementById('sell-title').value,
                price: parseInt(document.getElementById('sell-price').value),
                cat: document.getElementById('sell-cat').value,
                loc: document.getElementById('sell-loc').value,
                lat: 20 + Math.random() * 10, // Mock Lat
                lng: 75 + Math.random() * 10, // Mock Lng
                status: 'sale',
                seller: 'You',
                verified: false,
                approved: false
            };
            state.listings.push(newItem);
            alert("Ad posted! Pending Admin Approval.");
            e.target.reset();
            switchView('view-buy');
        }

        // --- CHAT ---
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-msgs');
            if(input.value.trim()) {
                box.innerHTML += `<div class="msg msg-sent">${input.value}</div>`;
                input.value = '';
                box.scrollTop = box.scrollHeight;
                setTimeout(() => {
                    box.innerHTML += `<div class="msg msg-received">We will connect you to the seller shortly.</div>`;
                    box.scrollTop = box.scrollHeight;
                }, 1000);
            }
        }

        // --- ADMIN ---
        function renderAdmin() {
            document.getElementById('adm-total').innerText = state.listings.length;
            const pending = state.listings.filter(i => !i.approved);
            document.getElementById('adm-pending').innerText = pending.length;
            document.getElementById('adm-rev').innerText = "₹" + state.revenue.toLocaleString();

            const grid = document.getElementById('admin-grid');
            grid.innerHTML = '';
            
            pending.forEach(item => {
                grid.innerHTML += `
                    <div class="card" style="padding:1rem;">
                        <div style="font-weight:bold;">${item.title}</div>
                        <div>₹${item.price}</div>
                        <div style="font-size:0.8rem; margin:5px 0;">Seller: ${item.seller}</div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" style="flex:1; padding:5px;" onclick="adminAction(${item.id}, true)">Approve</button>
                            <button class="btn btn-outline" style="flex:1; padding:5px; color:red; border-color:red;" onclick="adminAction(${item.id}, false)">Reject</button>
                        </div>
                    </div>
                `;
            });
            if(pending.length === 0) grid.innerHTML = '<p style="color:#777;">No pending approvals.</p>';
        }

        function adminAction(id, approve) {
            if(approve) {
                const item = state.listings.find(i => i.id === id);
                item.approved = true;
            } else {
                state.listings = state.listings.filter(i => i.id !== id);
            }
            renderAdmin();
        }

    </script>
</body>
</html>
